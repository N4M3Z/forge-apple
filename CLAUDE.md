# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> Autogenerated by `/Init` (`forge-init.sh`). Do not edit directly — run `/Update` (`forge-update.sh`) to regenerate.

## What This Is

forge-apple is a macOS-only Claude Code plugin providing Apple platform integration: Safari tab capture, Apple Music playlist automation, and Calendar/Reminders management via `ekctl`. Pure shell scripts and AppleScript — no Rust, no build step.

Part of forge-core's **Behaviour** layer. Registered as a Claude Code plugin via `.claude-plugin/plugin.json`. No active hooks (`events: []`); all functionality is exposed through skills.

## Development

No build step. Lint shell scripts:

```bash
shellcheck bin/*.sh
```

No automated tests — AppleScript requires a GUI session. Test manually on macOS.

## Code Style

- `#!/usr/bin/env bash` + `set -euo pipefail`
- Double-quote all variables: `"$VAR"`, not `$VAR`
- Use `command rm`, `command cp`, `command mv` — never bare (macOS aliases add `-i`)
- AppleScript blocks use heredoc with `<<'APPLESCRIPT'` (single-quoted delimiter prevents shell interpolation)
- Pass `shellcheck` with no warnings

## Architecture

### Plugin Registration

`.claude-plugin/plugin.json` registers with Claude Code. Skills in `skills/` are auto-discovered. Hooks in `hooks/hooks.json` are empty (no event subscriptions).

### Skills (3)

Skills follow the index + operation pattern: `SKILL.md` is the index with frontmatter (`name`, `description` with `USE WHEN` triggers, `user_invocable: true`), operation files describe step-by-step workflows.

| Skill | Trigger | What it does |
|-------|---------|-------------|
| `/Demo` | today, schedule, calendar, reminders, daily overview | HUD readout (calendar + reminders + Safari tabs) with interactive write-back actions |
| `/Music` | apple music, playlist, music automation | Creates Apple Music playlists from JSON spec via AppleScript |
| `/Safari` | safari, capture tabs, snapshot tabs | Exports local + iCloud tabs to dated markdown archive |

### Scripts

| Script | Input | Output |
|--------|-------|--------|
| `bin/safari-tabs.sh --count` | (none, reads Safari + CloudTabs.db) | Tab counts per device |
| `bin/safari-tabs.sh --export` | (none) | Markdown links grouped by device |
| `bin/music-playlists.sh <file.json>` | JSON playlist spec | 4-phase AppleScript: delete → create → populate → verify |

`music-playlists.sh` is idempotent — deletes matching playlists before recreating. Tracks are matched by searching the Apple Music library; `MISS` means the album isn't in the library yet.

### Configuration

- `defaults.yaml` — shipped defaults (calendar aliases, reminder lists, event filters, music folder). Committed.
- `config.yaml` — user overrides with only changed keys. Gitignored.

### External Dependencies

| Tool | Required | Purpose |
|------|----------|---------|
| macOS | Yes | AppleScript, SQLite (CloudTabs.db) |
| `ekctl` | Optional | Calendar + Reminders via EventKit CLI |
| `jq` | For Music/Demo | JSON parsing, URL encoding |

Without `ekctl`, Calendar/Reminders features are unavailable; Safari and Music still work.

### Path Resolution

Scripts reference themselves via `FORGE_MODULE_ROOT` env var (set by forge-core dispatch) with fallback:

```bash
"${FORGE_MODULE_ROOT:-Modules/forge-apple}/bin/safari-tabs.sh"
```

## Key Patterns

- AppleScript is built as a shell string, then executed with `osascript -e`. Double quotes inside AppleScript must be escaped with `sed 's/"/\\"/g'`.
- `music-playlists.sh` builds four separate AppleScript blocks (delete, create, populate, verify) and executes each sequentially. The populate script assigns playlists to numbered variables (`p0`, `p1`, ...) to reference them during track addition.
- Safari cloud tabs come from SQLite (`~/Library/Safari/CloudTabs.db`), not AppleScript. Local tabs require Safari to be running.
